<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assessment Results</title>
<link rel="stylesheet" href="css/theme.css">
<link rel="stylesheet" href="css/style.css">
<link rel="stylesheet" href="css/results.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
body { font-family: Arial, sans-serif; padding: 10px; background:#f4f4f4; }
.screen { display: none; }
h2 { margin-top: 0; }
.card { background: #fff; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; }
}
.print-btn { background: green; color: white; margin-top:10px;}
.flex-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
</style>
</head>
<body>
<!-- Top & Bottom Frames -->
<div class="frame-top"></div>
<div class="frame-bottom"></div>
<div class="main-content">
<div class="screen" id="screen1">
  <div class="flex-row">
    <h2>Clients</h2>
    <button onclick="toggleSortOrder()" class="btn" id="sortBtn">Sort A–Z</button>
  </div>
  <div id="nameList"></div>
</div>


<div class="screen" id="screen2">
  <h2>Dates</h2>
  <button onclick="prevScreen(2)" class="btn">Back</button>
  <div id="dateList"></div>
</div>

<div class="screen" id="screen3">
  <h2>Results</h2>
  <button onclick="prevScreen(3)" class="btn">Back</button>
  <div id="resultDisplay"></div>
</div>

<script>
let resultsStorage = JSON.parse(localStorage.getItem("resultsStorage")) || {};
let currentPatientKey = null;
let currentDate = null;

// Show first screen
document.getElementById("screen1").style.display = "block";

// Save new patient (safe kahit may comma o dot)
function saveNewPatient(rawName) {
  const patientKey = encodeURIComponent(rawName.trim());
  if (!resultsStorage[patientKey]) {
    resultsStorage[patientKey] = {};
    localStorage.setItem("resultsStorage", JSON.stringify(resultsStorage));
    loadPatientList();
  }
}

// Load patient names
let sortAsc = true; // default A–Z

function toggleSortOrder() {
  sortAsc = !sortAsc;
  loadPatientList();
  document.getElementById("sortBtn").textContent = sortAsc ? "Sort A–Z" : "Sort Z–A";
}

function loadPatientList() {
  const div = document.getElementById("nameList");
  div.innerHTML = "";

  // i-sort ang keys bago gamitin
  const sortedKeys = Object.keys(resultsStorage).sort((a, b) => {
    const nameA = decodeURIComponent(a).toLowerCase();
    const nameB = decodeURIComponent(b).toLowerCase();
    return sortAsc ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
  });

  sortedKeys.forEach(patientKey => {
    const row = document.createElement("div");
    row.className = "flex-row";

    // Decode para lumabas ang tunay na pangalan
    const decodedName = decodeURIComponent(patientKey);

    const btn = document.createElement("button");
    btn.textContent = decodedName;
    btn.className = "btn";
    btn.onclick = () => {
      currentPatientKey = patientKey;
      nextScreen(1);
      loadDateList(patientKey);
    };

    row.appendChild(btn);
    div.appendChild(row);
  });
}
loadPatientList();

// Navigate screens
function nextScreen(screen) {
  document.getElementById(`screen${screen}`).style.display = "none";
  document.getElementById(`screen${screen+1}`).style.display = "block";
}
function prevScreen(screen) {
  document.getElementById(`screen${screen}`).style.display = "none";
  document.getElementById(`screen${screen-1}`).style.display = "block";
}

// Load dates for selected patient
function loadDateList(patientKey) {
  const div = document.getElementById("dateList");
  div.innerHTML = "";
  const dates = Object.keys(resultsStorage[patientKey]).filter(k=>k!=='info');
  if(dates.length === 0) { div.innerHTML = "<p>No dates found.</p>"; return; }

  dates.forEach(date => {
    const btn = document.createElement("button");
    btn.textContent = date;
    btn.className = "btn";
    btn.onclick = () => {
      currentDate = date;
      nextScreen(2);
      showResult(patientKey, date);
    };
    div.appendChild(btn);
  });
}

function showResult(patientKey, date) {
  const div = document.getElementById("resultDisplay");
  div.innerHTML = "";

  const info = resultsStorage[patientKey][date]?.info || {};
  const decodedName = decodeURIComponent(patientKey);
  const gender = info.gender || "";
  const age = info.age || "";

  // Top header container with delete button
  const topBar = document.createElement("div");
  topBar.style.display = "flex";
  topBar.style.justifyContent = "space-between";
  topBar.style.alignItems = "flex-start";
  topBar.style.marginBottom = "10px";

  const title = document.createElement("h3");
  title.textContent = "Client Information";

  const deleteBtn = document.createElement("button");
  deleteBtn.textContent = "Delete";
  deleteBtn.className = "btn delete-btn";
  deleteBtn.style.alignSelf = "flex-start";
  deleteBtn.style.marginRight = "15px";
  deleteBtn.style.marginTop = "5px";

  deleteBtn.onclick = () => {
    const lastName = decodedName.split(" ")[0];
    const lnameConfirm = prompt(`Type client LASTNAME (${lastName}) to confirm deletion:`);
    if (!lnameConfirm) return;

    if (lnameConfirm.toLowerCase() === lastName.toLowerCase()) {
      delete resultsStorage[patientKey][date];
      let hasAnyDateLeft = Object.keys(resultsStorage[patientKey]).some(k => k !== 'info');
      if (!hasAnyDateLeft) delete resultsStorage[patientKey];
      localStorage.setItem("resultsStorage", JSON.stringify(resultsStorage));
      loadPatientList();
      document.getElementById("screen3").style.display = "none";
      document.getElementById("screen1").style.display = "block";
      alert("Record deleted. Returned to Name List.");
    } else {
      alert("Last name does not match. Deletion canceled.");
    }
  };

  topBar.appendChild(title);
  topBar.appendChild(deleteBtn);
  div.appendChild(topBar);

  // Client info card
  const clientCard = document.createElement("div");
  clientCard.className = "card";
  clientCard.innerHTML = `
      <p><em>Name:</em> ${decodedName}<br>
      <em>Gender:</em> ${gender}<br>
      <em>Age:</em> ${age}<br>
      <em>Date:</em> ${date}</p>
  `;
  div.appendChild(clientCard);

  // Assessment Results Header
  const header = document.createElement("h3");
  header.textContent = "Assessment Results";
  div.appendChild(header);

  // Results
  const categories = Object.keys(resultsStorage[patientKey][date]).filter(k => k !== 'info');
  categories.forEach(cat => {
    const catTitle = document.createElement("h4");
    catTitle.textContent = cat;
    div.appendChild(catTitle);

    Object.keys(resultsStorage[patientKey][date][cat]).forEach(itemName => {
      const item = resultsStorage[patientKey][date][cat][itemName];

      // Skip if no type or color
      if (!item.type || !item.color) return;

      const color = item.color;
      const card = document.createElement("div");
      card.className = "card";
      card.style.borderLeft = `5px solid ${color}`; // highlight by color
      card.innerHTML = `
        <p><strong>${itemName} (${item.type})</strong></p>
        <p><em>Meaning:</em> <strong>${item.meaning}</strong></p>
        <p><em>Condition:</em> <strong>${item.condition}</strong></p>
        <p><em>Advice:</em> <strong>${item.advice}</strong></p>
        ${item.notes ? `<p><em>Notes:</em> <strong style="color:${color}">${item.notes}</strong></p>` : ""}
      `;
      div.appendChild(card);
    });
  });

// Print button
const printBtn = document.createElement("button");
printBtn.textContent = "Print / Save PDF";
printBtn.className = "btn print-btn";
printBtn.onclick = () => {
  const element = document.getElementById("resultDisplay");
  html2pdf().from(element).set({
    margin: 0.5,
    filename: `${decodedName.replace(/ /g,"_")}_${date}.pdf`,
    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] },
    html2canvas: { scale: 2, useCORS: true }
  }).save();
};
div.appendChild(printBtn);
}
</script>
</body>
</html>